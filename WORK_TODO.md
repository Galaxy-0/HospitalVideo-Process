# 医院Agent质控MVP - 详细工作列表

基于 PRD.md 制定的完整开发任务清单，按优先级和时间线组织。

---

## 📋 总览

**项目目标**: 验证"大模型 + 质控 Prompt"对手术文字步骤进行结构化评分的可行性  
**时间线**: 4天 (D0-D3)  
**成功标准**: 10份示例数据中 ≥70% 被质控医生评为"有实用价值"

---

## 🎯 D0 任务清单 (项目初始化)

### ✅ 已完成
- [x] PRD.md 文档确认
- [x] Git版本管理初始化
- [x] 项目结构搭建 (pyproject.toml, .gitignore, CHANGELOG.md)
- [x] 切换到dev分支

### 🔄 进行中
- [ ] **工作列表制定** (当前任务)

---

## 🚀 D1 任务清单 (核心实现)

### 1. 环境配置 (优先级: 🔴 高)
- [ ] **1.1** 配置uv虚拟环境
  ```bash
  uv venv
  source .venv/bin/activate  # Linux/Mac
  # 或 .venv\Scripts\activate  # Windows
  ```
- [ ] **1.2** 复制 `env.example` 到 `.env` 并配置API密钥
- [ ] **1.3** 验证Python 3.11+环境

### 2. 核心代码实现 (优先级: 🔴 高)
- [ ] **2.1** 创建 `src/` 目录结构
  ```
  src/
  ├── __init__.py
  ├── evaluate.py      # 主评估脚本
  ├── prompt.py        # Prompt模板管理
  ├── openai_client.py # OpenAI API调用封装
  └── utils.py         # 工具函数
  ```

- [ ] **2.2** 实现 `src/openai_client.py`
  - [ ] 使用 `urllib.request` 构造HTTP POST请求
  - [ ] 实现 `call_openai_api(messages, model="gpt-4o")` 函数
  - [ ] 添加错误处理和重试机制
  - [ ] 实现JSON解析和验证

- [ ] **2.3** 实现 `src/prompt.py`
  - [ ] 设计系统Prompt模板
  - [ ] 定义用户Prompt格式
  - [ ] 实现Prompt拼装函数
  - [ ] 添加手术类型特定的提示词

- [ ] **2.4** 实现 `src/evaluate.py` 主脚本
  - [ ] 命令行参数解析 (`--file`, `--type`)
  - [ ] 文件读取功能
  - [ ] 调用OpenAI API
  - [ ] 结果输出和格式化
  - [ ] 异常处理

### 3. Prompt设计 (优先级: 🔴 高)
- [ ] **3.1** 创建 `prompts/system_prompt.md`
  - [ ] 定义专家角色和任务
  - [ ] 明确输出JSON格式要求
  - [ ] 设置评分标准和维度

- [ ] **3.2** 创建手术类型特定提示
  - [ ] `prompts/appendectomy.md` (阑尾切除)
  - [ ] `prompts/cholecystectomy.md` (胆囊切除)  
  - [ ] `prompts/gastric_perforation.md` (胃穿孔修补)

- [ ] **3.3** 设计JSON输出Schema
  ```json
  {
    "total_score": 85,
    "risks": ["术中出血风险", "感染风险"],
    "suggestions": ["建议加强止血", "术后抗感染治疗"],
    "risk_level": "Medium"
  }
  ```

### 4. 测试框架搭建 (优先级: 🟡 中)
- [ ] **4.1** 创建 `tests/` 目录结构
  ```
  tests/
  ├── __init__.py
  ├── test_openai_client.py
  ├── test_prompt.py
  ├── test_evaluate.py
  └── fixtures/
      └── mock_responses.json
  ```

- [ ] **4.2** 编写单元测试
  - [ ] Mock OpenAI API响应
  - [ ] 测试Prompt拼装逻辑
  - [ ] 测试JSON解析功能
  - [ ] 测试错误处理

---

## 📊 D2 任务清单 (数据准备与测试)

### 1. 示例数据准备 (优先级: 🔴 高)
- [ ] **1.1** 创建 `data/` 目录结构
  ```
  data/
  ├── samples/
  │   ├── appendectomy_01.txt
  │   ├── appendectomy_02.txt
  │   ├── cholecystectomy_01.txt
  │   ├── cholecystectomy_02.txt
  │   ├── gastric_perforation_01.txt
  │   └── gastric_perforation_02.txt
  └── templates/
      └── surgery_template.txt
  ```

- [ ] **1.2** 编写手术步骤示例文本 (每种手术至少3-4份)
  - [ ] 阑尾切除手术步骤 (正常案例 + 异常案例)
  - [ ] 胆囊切除手术步骤 (腹腔镜 + 开腹)
  - [ ] 胃穿孔修补手术步骤 (不同穿孔位置)

- [ ] **1.3** 创建预期输出参考
  - [ ] `data/expected/` 目录
  - [ ] 人工评分参考标准
  - [ ] 关键风险点清单

### 2. 批量测试实现 (优先级: 🟡 中)
- [ ] **2.1** 实现 `scripts/batch_evaluate.py`
  - [ ] 批量处理所有示例文件
  - [ ] 生成统一格式的结果报告
  - [ ] 计算平均分和分布统计

- [ ] **2.2** 实现结果收集和分析
  - [ ] 创建 `results/` 目录
  - [ ] CSV格式输出结果
  - [ ] 生成可视化图表 (可选)

### 3. 质量保证 (优先级: 🟡 中)
- [ ] **3.1** 代码质量检查
  ```bash
  ruff check src/
  black src/
  ```
- [ ] **3.2** 运行测试套件
  ```bash
  pytest tests/ -v --cov=src
  ```
- [ ] **3.3** 性能测试
  - [ ] 测试API调用延迟
  - [ ] 验证Token使用量
  - [ ] 费用估算

---

## 🔍 D3 任务清单 (评审与优化)

### 1. 医生评审准备 (优先级: 🔴 高)
- [ ] **1.1** 准备评审材料
  - [ ] 整理所有测试结果
  - [ ] 创建评审表格模板
  - [ ] 准备对比分析报告

- [ ] **1.2** 实现快速评测脚本 `scripts/quick_eval.py`
  - [ ] 人工评分输入界面
  - [ ] 模型输出与人工评分对比
  - [ ] 统计成功率和一致性

### 2. 结果分析与优化 (优先级: 🟡 中)
- [ ] **2.1** 分析模型输出质量
  - [ ] 识别常见错误模式
  - [ ] 统计各手术类型准确率
  - [ ] 分析风险识别能力

- [ ] **2.2** Prompt优化 (如需要)
  - [ ] 根据测试结果调整系统提示
  - [ ] 优化JSON输出格式
  - [ ] 增强医学术语处理

### 3. 文档完善 (优先级: 🟢 低)
- [ ] **3.1** 更新 `README.md`
  - [ ] 添加快速开始指南
  - [ ] 使用示例和命令
  - [ ] API调用说明

- [ ] **3.2** 更新 `CHANGELOG.md`
  - [ ] 记录所有功能实现
  - [ ] 版本发布说明
  - [ ] 已知问题和限制

### 4. MVP评审会准备 (优先级: 🔴 高)
- [ ] **4.1** 准备演示材料
  - [ ] 实时演示脚本
  - [ ] 结果对比展示
  - [ ] 技术架构说明

- [ ] **4.2** 准备汇报PPT
  - [ ] MVP目标达成情况
  - [ ] 技术实现亮点
  - [ ] 下一步发展规划

---

## 🔧 开发环境配置清单

### 必需工具
- [ ] Python 3.11+
- [ ] uv (包管理器)
- [ ] Git
- [ ] 文本编辑器 (VS Code推荐)

### 推荐工具
- [ ] pytest (测试)
- [ ] black (代码格式化)
- [ ] ruff (代码检查)
- [ ] httpx (HTTP测试, 可选)

---

## 📈 成功指标

### 技术指标
- [ ] 所有示例文件能成功处理
- [ ] API调用成功率 > 95%
- [ ] 平均响应时间 < 30秒
- [ ] JSON输出格式正确率 100%

### 业务指标  
- [ ] 医生评审"有实用价值"比例 ≥ 70%
- [ ] 风险识别准确率 ≥ 80%
- [ ] 改进建议相关性 ≥ 75%

---

## ⚠️ 风险缓解措施

### 技术风险
- [ ] **API限流**: 实现指数退避重试机制
- [ ] **JSON解析失败**: 添加格式验证和修复逻辑
- [ ] **费用超支**: 设置Token限制和预算监控

### 业务风险
- [ ] **医学术语歧义**: 建立术语标准化词典
- [ ] **评分标准不一致**: 制定详细评分规则
- [ ] **示例数据质量**: 多轮人工审核验证

---

## 📝 每日检查清单

### 每日必做
- [ ] 检查API调用是否正常
- [ ] 运行测试套件
- [ ] 更新CHANGELOG.md
- [ ] 提交代码到Git

### 每日可选
- [ ] 代码质量检查 (ruff + black)
- [ ] 性能监控
- [ ] 文档更新

---

*最后更新: 2024-01-XX*  
*当前分支: dev*  
*版本: 0.1.0-dev* 